<!-- This page is a simple frontend to show instruction and to run API calls -->
<!-- TODO: dynamically remove default values -->
<!-- TODO: 1. connect to NEAR wallet and Algorand wallet -->
<!-- TODO: 2. before mint, user should opt in to goNEAR ASA -->
<!-- TODO: 3. before API call, user should make a transaction, and use the returned txnId -->
<!-- TODO: 4. on button click: pass 4 params(to,from,amount,txnId) to API in server.ts -->

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="index.css">
    <title>Algorand - NEAR Bridge</title>
  </head>

  <body>
    <header>
      <h1>Algorand - NEAR Bridge</h1>
      <p>This is a demo of the Algorand Bridge for NEAR.</p>
    </header>

    <div id="app">
      <div id="account-nav">
        <div id="near-group">
          <button id="near-connect-btn">Connect NEAR Wallet</button>
          <p id="near-address"></p>
          <button id="near-signout-btn" style="display: none;">Sign Out</button>
        </div>

        <div id="algorand-group">
          <button id="algorand-connect-btn" onclick="connectToMyAlgo()">Connect My Algo Wallet</button>
          <p id="algo-address"></p>
          <button id="algorand-optin" onclick="optIngoNEAR()" style="display: none;">goNEAR Opt In(skip if finished
            first time)</button>
        </div>
      </div>

      <div id="txn">
        <div id="tab-interface">
          <ul class="tabs func-selection" role="tablist">
            <li class="func-selection">
              <input type="radio" name="tabs" id="tab1" checked class="func-selection">
              <label for="tab1" role="tab" aria-controls="mint" class="panel1 func-selection" tabindex="0">
                mint
              </label>
            </li>
            <li class="func-selection">
              <input type="radio" name="tabs" id="tab2" class="func-selection">
              <label for="tab2" role="tab" aria-controls="burn" class="panel2 func-selection" tabindex="1">
                burn
              </label>
            </li>
          </ul>
        </div>

        <div id="mint" role="tabpanel" style="display: block;">
          <div>
            <h3>1. Transfer NEAR token to Escrow account</h3>
            <p>After you finish the transaction, please click 'View on Explorer' button to get the transaction hash for
              next step</p>
            <a href="https://wallet.testnet.near.org/send-money" target="_blank">
              <button id="near-transfer" class="clickBtn">Transfer</button>
            </a>
          </div>

          <div>
            <h3>2. Fill in the transaction hash from first step</h3>
            <label>Transaction Hash
              <input type="text" name="mint_txnId" id="mint_txnId"
                placeholder="Am1ZQx651WwYXZzBbtKV35YYPP6Tc5epvCfebv5XRn4K" size="50">
            </label>
            <br />
            <label>
              From (NEAR public address)
              <input type="text" name="mint_from" id="mint_from" placeholder="abstrlabs.testnet" size="50" />
            </label>
            <br />
            <button id="check-tx" onclick="checkNEARtx()" class="clickBtn">Hash Check</button>
          </div>

          <div>
            <h3>3. Mint to get goNEAR from Escrow account</h3>
            <form action="/api/mint" method="post">
              <label>
                To (Algorand public address)
                <input type="text" name="mint_to" id="mint_to"
                  placeholder="ACCSSTKTJDSVP4JPTJWNCGWSDAPHR66ES2AZUAH7MUULEY43DHQSDNR7DA" size="50" />
              </label>
              <br />
              <label>
                From (NEAR public address)
                <input type="text" name="mint_from" id="mint_from_filled" placeholder="abstrlabs.testnet" size="50" />
              </label>
              <br />
              <label>
                Amount
                <input type="number" name="mint_amount" id="mint_amount" placeholder="10" step="0.0000000001" />
              </label>
              <br />
              <label>Transaction Hash
                <input type="text" name="mint_txnId" id="mint_txnId_filled"
                  placeholder="Am1ZQx651WwYXZzBbtKV35YYPP6Tc5epvCfebv5XRn4K" size="50">
              </label>
              <br />
              <button id="mint-button" class="clickBtn" disabled>MINT</button>
            </form>
          </div>
        </div>

        <div id="burn" role="tabpanel" style="display: none;">
          <div>
            <!-- <a
            href="https://dispenser.testnet.aws.algodev.network/"
            target="_blank">
            testnet faucet algorand</a> -->
            <h3>1. Transfer goNEAR token to Escrow account</h3>
            <label>
              Amount

              <input type="number" name="burn_amount" id="burn_amount" placeholder="10" step="0.0000000001" />
            </label>
            <button id="algorand-transfer" onclick="goNEARTransfer()" class="clickBtn">Algo Transfer</button>
          </div>

          <div>
            <h3>2. Fill in the transaction ID</h3>
            <label>Transaction ID
              <input type="text" name="burn_txnId" id="burn_txnId"
                placeholder="Am1ZQx651WwYXZzBbtKV35YYPP6Tc5epvCfebv5XRn4K" size="50">
            </label>
            <br />
            <button id="check-tx-algo" onclick="checkAlgotx()" class="clickBtn">Hash Check</button>
          </div>

          <div>
            <h3>3. Burn goNEAR from Escrow account</h3>
            <form action="/api/burn" method="post">
              <label>
                From (Algorand public address)
                <input type="text" name="burn_from"
                  placeholder="ACCSSTKTJDSVP4JPTJWNCGWSDAPHR66ES2AZUAH7MUULEY43DHQSDNR7DA" size="50" />
              </label>
              <br />
              <label>
                To (NEAR public address)
                <input type="text" name="burn_to" placeholder="abstrlabs-test.testnet" />
              </label>
              <br />
              <label>
                Amount
                <input type="number" name="burn_amount_filled" placeholder="10" />
              </label>
              <br />
              <label>Transaction ID
                <input type="text" name="burn_txnId">
              </label>
              <br />
              <button id="burn-button" class="clickBtn" disabled>BURN</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </body>

  <script src="https://cdn.jsdelivr.net/npm/near-api-js@0.41.0/dist/near-api-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/algosdk@v1.16.0/dist/browser/algosdk.min.js"
    crossorigin="anonymous"></script>
  <script src="./myalgo.min.js"></script>

  <script>
    /* NEAR wallet CONNECT and function */

    // modified from https://docs.near.org/docs/faq/naj-faq
    // connect to NEAR
    const near = new nearApi.Near({
      keyStore: new nearApi.keyStores.BrowserLocalStorageKeyStore(),
      networkId: 'testnet',
      nodeUrl: 'https://rpc.testnet.near.org',
      walletUrl: 'https://wallet.testnet.near.org'
    });

    // connect to the NEAR Wallet
    const nearWallet = new nearApi.WalletConnection(near, 'algorand-bridge');

    let nearConnectButton = document.getElementById('near-connect-btn');
    let nearSignoutButton = document.getElementById('near-signout-btn');
    let nearAddress = document.getElementById('near-address');

    if (!nearWallet.isSignedIn()) {
      nearConnectButton.textContent = 'Sign In with NEAR wallet'
    } else if (nearWallet.isSignedIn()) {
      nearConnectButton.textContent = 'NEAR Wallet Connected'
      nearAddress.textContent = ' ' + nearWallet.getAccountId().toString()
    }

    // Either sign in or transaction method on button click
    nearConnectButton.addEventListener('click', () => {
      if (nearWallet.isSignedIn()) {
        nearConnectButton.disabled = true;
        nearSignoutButton.style.display = 'block';
      } else {
        nearConnectButton.textContent = 'loading...'
        nearWallet.requestSignIn('abstrlabs.testnet');
      }
    });

    nearSignoutButton.addEventListener('click', () => {
      if (nearWallet.isSignedIn()) {
        nearWallet.signOut();
        nearSignoutButton.textContent = 'loading...'
        location.reload();
      }
    });

    /* NEAR transaction check*/
    let nearTxhash = document.getElementById('mint_txnId');
    let nearSigner = document.getElementById('mint_from');

    let nearAmount = document.getElementById('mint_amount');
    let filledTx = document.getElementById('mint_txnId_filled');
    let filledAccount = document.getElementById('mint_from_filled');

    const checkNEARtx = async () => {
      try {
        const result = await near.connection.provider.txStatus(nearTxhash.value, nearSigner.value)
        console.log(result.status.SuccessValue === "")
        let NEARamount = nearApi.utils.format.formatNearAmount(result.transaction.actions[0].Transfer.deposit)
        if (result.status.SuccessValue === "") {
          document.getElementById('mint-button').disabled = false
          nearAmount.value = NEARamount
          filledTx.value = result.transaction.hash
          filledAccount.value = result.transaction.signer_id
        }
      } catch (err) {
        console.error(err);
      }
    }
  </script>

  <script>

    /* Algorand wallet connect */
    const myAlgoWallet = new MyAlgoConnect();
    let algoAccountButton = document.getElementById('algorand-connect-btn');
    let algoAddressContext = document.getElementById('algo-address');
    let algoOptInButton = document.getElementById('algorand-optin');
    let algorandAddress;

    const connectToMyAlgo = async () => {
      try {
        const accounts = await myAlgoWallet.connect();
        algorandAddress = accounts[0].address;
        algoAccountButton.textContent = algoAccountButton.textContent
        algoAddressContext.textContent = algorandAddress
        algoAccountButton.disabled = true;
        algoOptInButton.style.display = 'block';
      } catch (err) {
        console.error(err);
      }
    }

    const algodClient = new algosdk.Algodv2('', 'https://node.testnet.algoexplorerapi.io', '');
    const to = 'JMJLRBZQSTS6ZINTD3LLSXCW46K44EI2YZHYKCPBGZP3FLITIQRGPELOBE';

    /*Warning: Browser will block pop-up if user doesn't trigger myAlgoWallet.connect() with a button interation */

    /* Algorand wallet transfer function */
    async function signTransaction(from, to, amountAlgo) {
      try {
        const suggestedParams = await algodClient.getTransactionParams().do();
        console.log({ suggestedParams, from, to, amount: amountAlgo })
        const txn = algosdk.makeAssetTransferTxnWithSuggestedParamsFromObject({ suggestedParams, from, to, amount: amountAlgo, assetIndex: 83251085 });
        const signedTxn = await myAlgoWallet.signTransaction(txn.toByte());
        const response = await algodClient.sendRawTransaction(signedTxn.blob).do();
        return response
      } catch (err) {
        console.error(err);
      }
    };

    let algoAmount = document.getElementById('burn_amount');
    const algo_unit = 10000000000;
    const goNEARTransfer = async () => {
      try {
        const from = algorandAddress; // change
        const amountAlgo = algoAmount.value * 10000000000;
        const response = await signTransaction(from, to, amountAlgo);
        console.log(response)
      } catch (err) {
        console.error(err);
      }
    }

    const optIngoNEAR = async () => {
      const from = algorandAddress;
      const amountAlgo = 0;
      const response = await signTransaction(from, from, amountAlgo);
      console.log(response)
    }

    const checkAlgotx = async () => {
      try {
        const result = await near.connection.provider.txStatus(nearTxhash.value, nearSigner.value)
        console.log(result.status.SuccessValue === "")
        let NEARamount = nearApi.utils.format.formatNearAmount(result.transaction.actions[0].Transfer.deposit)
        if (result.status.SuccessValue === "") {
          document.getElementById('mint').disabled = false
          nearAmount.value = NEARamount
          filledTx.value = result.transaction.hash
          filledAccount.value = result.transaction.signer_id
        }
      } catch (err) {
        console.error(err);
      }
    }
  </script>

  <script>
    /*tab selection for mint and burn*/
    let tab1Button = document.getElementById('tab1');
    let tab2Button = document.getElementById('tab2');
    let mintForm = document.getElementById('mint');
    let burnForm = document.getElementById('burn');

    tab1Button.addEventListener('change', (event) => {
      if (tab1Button.checked === true) {
        mintForm.style.display = "block"
        burnForm.style.display = "none"
      } else {
        mintForm.style.display = "none"
        burn.style.display = "block"
      }
    })

    tab2Button.addEventListener('change', (event) => {
      if (tab2Button.checked === true) {
        mintForm.style.display = "none"
        burn.style.display = "block"
      } else {
        mintForm.style.display = "block"
        burnForm.style.display = "none"
      }
    })
  </script>

</html>