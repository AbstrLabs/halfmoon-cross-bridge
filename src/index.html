<!-- This page is a simple frontend to show instruction and to run API calls -->
<!-- TODO: dynamically remove default values -->
<!-- TODO: 1. connect to NEAR wallet and Algorand wallet -->
<!-- TODO: 2. before mint, user should opt in to goNEAR ASA -->
<!-- TODO: 3. before API call, user should make a transaction, and use the returned txnId -->
<!-- TODO: 4. on button click: pass 4 params(to,from,amount,txnId) to API in server.ts -->

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * {
        box-sizing: border-box;
        background-color: #000;
        color: #fff;
      }

      html {
        font-size: 24px;
      }

      table,
      th,
      td {
        border-collapse: collapse;
        border: 1px solid #fff;
      }
    </style>
    <title>Algorand - NEAR Bridge</title>
  </head>

  <body>
    <header>
      <h1>Algorand - NEAR Bridge</h1>
      <p>This is a demo of the Algorand Bridge for NEAR.</p>
    </header>

    <div id="app">
      <div id="near-group">
        <button id="near-connect-btn">Connect NEAR Wallet</button>
        <button id="near-signout-btn" style="display: none;">Sign Out</button>
      </div>

      <div id="algorand-group">
        <button id="algorand-connect-btn" onclick="connectToMyAlgo()">Connect My Algo Wallet</button>
        <p id="algo-address"></p>
        <button id="algorand-optin" onclick="optIngoNEAR()">goNEAR Opt In</button>
      </div>

      <div id="txn">
        <div>
          <h2>Mint</h2>
          <div>
            <h3>1. Transfer NEAR token to Escrow account</h3>
            <p>After you finish the transaction, please click 'view on explorer' button to get the transaction hash for next step</p>
            <a href="https://wallet.testnet.near.org/send-money" target="_blank"><button id="near-transfer">Transfer</button></a>
          </div>

          <div>
            <h3>2. Fill in the transaction hash based on your explorer information you get on first step</h3>
            <label>Transaction Hash
              <input type="text" name="mint_txnId" id="mint_txnId" placeholder="Input your send NEAR token transaction hash" value="Am1ZQx651WwYXZzBbtKV35YYPP6Tc5epvCfebv5XRn4K">
            </label>
            <label>
              From (NEAR public address)
              <input type="text" name="mint_from" id="mint_from" placeholder="abstrlabs.testnet" value="testalgo.testnet" />
            </label>
            <button id="check-tx" onclick="checkNEARtx()">Hash Check</button>
          </div>

          <div>
            <h3>3. Mint</h3>
            <form action="/api/mint" method="post">
              <label>
                To (Algorand public address)
                <input type="text" name="mint_to" id="mint_to" placeholder="ACCSSTKTJDSVP4JPTJWNCGWSDAPHR66ES2AZUAH7MUULEY43DHQSDNR7DA" />
              </label>
              <br />
              <label>
                From (NEAR public address)
                <input type="text" name="mint_from" id="mint_from_filled" placeholder="abstrlabs.testnet" />
              </label>
              <br />
              <label>
                Amount
                <input type="number" name="mint_amount" id="mint_amount" placeholder="10" />
              </label>
              <br />
              <label>Transaction Hash
                <input type="text" name="mint_txnId" id="mint_txnId_filled" placeholder="Am1ZQx651WwYXZzBbtKV35YYPP6Tc5epvCfebv5XRn4K">
              </label>
              <button id="mint" disabled>MINT</button>
            </form>
          </div>
        </div>

        <div>
          <div>
            <h2>Burn</h2>
            <!-- <a
            href="https://dispenser.testnet.aws.algodev.network/"
            target="_blank">
            testnet faucet algorand</a> -->
            <label>
              Amount
              <input type="number" name="burn_amount" id="burn_amount" placeholder="10" />
            </label>
            <button id="algorand-transfer" onclick="goNEARTransfer()">Algo Transfer</button>
          </div>

          <form action="/api/burn" method="post">
            <label>
              From (Algorand public address)
              <input type="text" name="burn_from" value="abstrlabs-test.testnet" />
            </label>
            <br />
            <label>
              To (NEAR public address)
              <input type="text" name="burn_to" value="ACCSSTKTJDSVP4JPTJWNCGWSDAPHR66ES2AZUAH7MUULEY43DHQSDNR7DA" />
            </label>
            <br />
            <label>
              Amount
              <input type="number" name="burn_amount" value="987.654" />
            </label>
            <label>Transaction ID
              <input type="text" name="burn_txnId">
            </label>
            <button>BURN</button>
          </form>
        </div>
      </div>

    </div>
  </body>

  <script src="https://cdn.jsdelivr.net/npm/near-api-js@0.41.0/dist/near-api-js.min.js"></script>
  <script
  src="https://cdn.jsdelivr.net/npm/algosdk@v1.16.0/dist/browser/algosdk.min.js"
  crossorigin="anonymous"
></script>
  <script src="./myalgo.min.js"></script>

  <script>
    /* NEAR wallet CONNECT and function */

    // modified from https://docs.near.org/docs/faq/naj-faq
    // connect to NEAR
    const near = new nearApi.Near({
      keyStore: new nearApi.keyStores.BrowserLocalStorageKeyStore(),
      networkId: 'testnet',
      nodeUrl: 'https://rpc.testnet.near.org',
      walletUrl: 'https://wallet.testnet.near.org'
    });

    // connect to the NEAR Wallet
    const nearWallet = new nearApi.WalletConnection(near, 'algorand-bridge');

    let nearConnectButton = document.getElementById('near-connect-btn');
    let nearSignoutButton = document.getElementById('near-signout-btn');

    if (!nearWallet.isSignedIn()) {
      nearConnectButton.textContent = 'Sign In with NEAR wallet'
    } else if(nearWallet.isSignedIn()) {
      nearConnectButton.textContent = 'NEAR Wallet Connected with ' + nearWallet.getAccountId().toString()
    }

    // Either sign in or transaction method on button click
    nearConnectButton.addEventListener('click', () => {
      if (nearWallet.isSignedIn()) {
        nearConnectButton.disabled = true;
        nearSignoutButton.style.display = 'block';
      }else {
        nearConnectButton.textContent = 'loading...'
        nearWallet.requestSignIn('abstrlabs.testnet');
      }
    });

    nearSignoutButton.addEventListener('click', () => {
      if (nearWallet.isSignedIn()) {
        nearWallet.signOut();
        nearSignoutButton.textContent = 'loading...'
        location.reload();
      }
    });

    /* NEAR transaction check*/
    let nearTxhash = document.getElementById('mint_txnId');
    let nearSigner = document.getElementById('mint_from');

    let nearAmount = document.getElementById('mint_amount');
    let filledTx = document.getElementById('mint_txnId_filled');
    let filledAccount = document.getElementById('mint_from_filled');

    const checkNEARtx = async() => {
      try {
        const result = await near.connection.provider.txStatus(nearTxhash.value, nearSigner.value)
        console.log(result.status.SuccessValue === "")
        let NEARamount = nearApi.utils.format.formatNearAmount(result.transaction.actions[0].Transfer.deposit)
        if(result.status.SuccessValue === ""){
          document.getElementById('mint').disabled = false
          nearAmount.value = NEARamount
          filledTx.value = result.transaction.hash
          filledAccount.value = result.transaction.signer_id
        }
      } catch (err) {
        console.error(err);
      }
    }
  </script>

<script>

  /* Algorand wallet connect */
  const myAlgoWallet = new MyAlgoConnect();
  let algoAccountButton = document.getElementById('algorand-connect-btn');
  let algoAddressContext = document.getElementById('algo-address');
  let algorandAddress;

  const connectToMyAlgo = async() => {
    try {
      const accounts = await myAlgoWallet.connect();
      algorandAddress = accounts[0].address;
      algoAccountButton.textContent = algoAccountButton.textContent
      algoAddressContext.textContent = algorandAddress
      algoAccountButton.disabled = true;
    } catch (err) {
      console.error(err);
    }
  }

  const algodClient = new algosdk.Algodv2('', 'https://node.testnet.algoexplorerapi.io', '');
  const to = 'JMJLRBZQSTS6ZINTD3LLSXCW46K44EI2YZHYKCPBGZP3FLITIQRGPELOBE';

  /*Warning: Browser will block pop-up if user doesn't trigger myAlgoWallet.connect() with a button interation */
  
  /* Algorand wallet transfer function */
  async function signTransaction (from, to, amountAlgo) {
    try {
      const suggestedParams = await algodClient.getTransactionParams().do();
      console.log({ suggestedParams, from, to, amount:amountAlgo })
      const txn = algosdk.makeAssetTransferTxnWithSuggestedParamsFromObject({ suggestedParams, from, to, amount:amountAlgo, assetIndex: 83251085 });
      const signedTxn = await myAlgoWallet.signTransaction(txn.toByte());  
      const response = await algodClient.sendRawTransaction(signedTxn.blob).do();
      return response
    } catch(err) {
      console.error(err); 
    }
  };

  let algoAmount = document.getElementById('burn_amount');
  const algo_unit = 10000000000;
  const goNEARTransfer = async() => {
    try {
      const from = algorandAddress; // change
      const amountAlgo = algoAmount.value * 10000000000;
      const response = await signTransaction(from,to, amountAlgo);
      console.log(response)
    } catch (err) {
      console.error(err);
    }
  }

  const optIngoNEAR = async () => {
      const from = algorandAddress; 
      const amountAlgo = 0;
      const response = await signTransaction(from, from, amountAlgo);
      console.log(response)
  }
</script>

  
</html>